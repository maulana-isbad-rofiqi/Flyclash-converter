<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlyClash Override Generator</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a',
                        darker: '#020617',
                        primary: '#3b82f6',
                        accent: '#06b6d4',
                        success: '#10b981',
                    }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #020617; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .input-box { background: #0f172a; border: 1px solid #334155; color: #f8fafc; transition: all 0.3s; }
        .input-box:focus { border-color: #06b6d4; outline: none; box-shadow: 0 0 10px rgba(6, 182, 212, 0.3); }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { Terminal, Settings, Zap, Shield, Globe, Copy, Check, FileJson, Play, Save } = lucide;

        // --- UTILITY PARSERS ---
        
        const parseVmess = (link) => {
            try {
                const b64 = link.replace("vmess://", "");
                const decoded = atob(b64);
                const conf = JSON.parse(decoded);
                
                return {
                    name: conf.ps || "VMess Node",
                    type: "vmess",
                    server: conf.add,
                    port: parseInt(conf.port),
                    uuid: conf.id,
                    alterId: parseInt(conf.aid || 0),
                    cipher: "auto",
                    udp: true,
                    tls: conf.tls === "tls",
                    skipCertVerify: true,
                    servername: conf.host || conf.sni || "",
                    network: conf.net || "ws",
                    "ws-opts": conf.net === "ws" ? {
                        path: conf.path || "/",
                        headers: { Host: conf.host || "" }
                    } : undefined,
                    "grpc-opts": conf.net === "grpc" ? {
                        "grpc-service-name": conf.path || ""
                    } : undefined
                };
            } catch (e) { console.error("VMess Parse Error", e); return null; }
        };

        const parseVless = (link) => {
            try {
                const url = new URL(link);
                const params = url.searchParams;
                
                return {
                    name: decodeURIComponent(url.hash.slice(1)) || "VLESS Node",
                    type: "vless",
                    server: url.hostname,
                    port: parseInt(url.port),
                    uuid: url.username,
                    cipher: "auto",
                    udp: true,
                    tls: params.get("security") === "tls" || params.get("security") === "reality",
                    "skip-cert-verify": true,
                    servername: params.get("sni") || "",
                    network: params.get("type") || "tcp",
                    "client-fingerprint": params.get("fp") || "chrome",
                    "ws-opts": params.get("type") === "ws" ? {
                        path: params.get("path") || "/",
                        headers: { Host: params.get("host") || params.get("sni") || "" }
                    } : undefined,
                    "grpc-opts": params.get("type") === "grpc" ? {
                        "grpc-service-name": params.get("serviceName") || ""
                    } : undefined,
                    "reality-opts": params.get("security") === "reality" ? {
                        "public-key": params.get("pbk") || "",
                        "short-id": params.get("sid") || ""
                    } : undefined
                };
            } catch (e) { console.error("VLESS Parse Error", e); return null; }
        };

        const parseTrojan = (link) => {
            try {
                const url = new URL(link);
                const params = url.searchParams;

                return {
                    name: decodeURIComponent(url.hash.slice(1)) || "Trojan Node",
                    type: "trojan",
                    server: url.hostname,
                    port: parseInt(url.port),
                    password: url.username,
                    udp: true,
                    sni: params.get("sni") || url.hostname,
                    "skip-cert-verify": true,
                    network: params.get("type") || "tcp",
                    "ws-opts": params.get("type") === "ws" ? {
                        path: params.get("path") || "/",
                        headers: { Host: params.get("host") || params.get("sni") || "" }
                    } : undefined,
                    "grpc-opts": params.get("type") === "grpc" ? {
                        "grpc-service-name": params.get("serviceName") || ""
                    } : undefined
                };
            } catch (e) { return null; }
        };

        // --- MAIN APP COMPONENT ---

        const App = () => {
            const [input, setInput] = useState("");
            const [parsedNodes, setParsedNodes] = useState([]);
            const [output, setOutput] = useState("");
            const [loading, setLoading] = useState(false);
            const [copied, setCopied] = useState(false);

            // Settings State
            const [mode, setMode] = useState("url-test"); // url-test, selector, load-balance, fallback
            const [groupName, setGroupName] = useState("üöÄ FlyClash Proxy");
            const [customDNS, setCustomDNS] = useState("google"); // google, cloudflare, adguard
            const [blockAds, setBlockAds] = useState(false);
            const [allowLan, setAllowLan] = useState(true);
            const [injectApps, setInjectApps] = useState(false);
            const [skipCert, setSkipCert] = useState(true);

            // Parsing Logic
            useEffect(() => {
                if (!input) {
                    setParsedNodes([]);
                    return;
                }

                setLoading(true);
                const lines = input.split('\n').filter(l => l.trim() !== "");
                const nodes = [];

                lines.forEach(line => {
                    let node = null;
                    if (line.startsWith("vmess://")) node = parseVmess(line.trim());
                    else if (line.startsWith("vless://")) node = parseVless(line.trim());
                    else if (line.startsWith("trojan://")) node = parseTrojan(line.trim());
                    
                    if (node) {
                        // Apply Global Compatibility
                        if(skipCert) node['skip-cert-verify'] = true;
                        nodes.push(node);
                    }
                });

                setTimeout(() => {
                    setParsedNodes(nodes);
                    setLoading(false);
                }, 500); // Fake delay for UX
            }, [input, skipCert]);

            // Generation Logic
            useEffect(() => {
                if (parsedNodes.length === 0) {
                    setOutput("// Masukkan config V2Ray di atas untuk memulai...");
                    return;
                }

                const nodeNames = parsedNodes.map(n => n.name);
                const nodesJson = JSON.stringify(parsedNodes, null, 2);

                // DNS Config
                let dnsConfig = "";
                if (customDNS !== "normal") {
                    const dnsServers = customDNS === "google" ? ["8.8.8.8", "8.8.4.4"] 
                        : customDNS === "cloudflare" ? ["1.1.1.1", "1.0.0.1"]
                        : ["94.140.14.14", "94.140.15.15"]; // AdGuard
                    
                    dnsConfig = `
    config.dns = {
        "enable": true,
        "ipv6": false,
        "enhanced-mode": "fake-ip",
        "fake-ip-range": "198.18.0.1/16",
        "nameserver": ${JSON.stringify(dnsServers)},
        "fallback": []
    };`;
                }

                // App Rules
                let rulesConfig = "";
                if (injectApps) {
                    rulesConfig = `
    // Inject Rules for Apps
    const appRules = [
        "DOMAIN-SUFFIX,whatsapp.com,${groupName}",
        "DOMAIN-SUFFIX,whatsapp.net,${groupName}",
        "DOMAIN-KEYWORD,whatsapp,${groupName}",
        "DOMAIN-SUFFIX,tiktokv.com,${groupName}",
        "DOMAIN-SUFFIX,tiktokcdn.com,${groupName}",
        "DOMAIN-KEYWORD,tiktok,${groupName}",
        "DOMAIN-SUFFIX,mobilelegends.com,${groupName}",
        "DOMAIN-SUFFIX,mlbb.com,${groupName}"
    ];
    config.rules = appRules.concat(config.rules || []);`;
                }

                // Block Ads
                let adBlockConfig = "";
                if (blockAds) {
                    adBlockConfig = `
    // Basic AdBlock
    const adBlockRules = [
        "DOMAIN-KEYWORD,ads,REJECT",
        "DOMAIN-KEYWORD,adservice,REJECT",
        "DOMAIN-SUFFIX,doubleclick.net,REJECT"
    ];
    config.rules = adBlockRules.concat(config.rules || []);`;
                }

                // Proxy Group Construction
                const groupType = mode === "load-balance" ? "load-balance" : 
                                  mode === "fallback" ? "fallback" : 
                                  mode === "url-test" ? "url-test" : "select";
                
                const strategy = mode === "load-balance" ? `,"strategy": "consistent-hashing"` : "";
                const interval = (mode === "url-test" || mode === "fallback") ? `,"interval": 300, "tolerance": 50` : "";

                const script = `// FlyClash Override Script
// Generated at ${new Date().toLocaleString()}
// Nodes: ${parsedNodes.length} detected

function main(config) {
    // 1. Inject Nodes
    const newProxies = ${nodesJson};
    
    // Ensure proxies array exists
    if (!config.proxies) config.proxies = [];
    config.proxies = config.proxies.concat(newProxies);

    // 2. Extract Node Names
    const nodeNames = newProxies.map(p => p.name);

    // 3. Create Main Group
    const mainGroup = {
        "name": "${groupName}",
        "type": "${groupType}",
        "proxies": nodeNames,
        "url": "http://www.gstatic.com/generate_204"
        ${interval}
        ${strategy}
    };

    // Ensure proxy-groups exists
    if (!config['proxy-groups']) config['proxy-groups'] = [];
    
    // Add our group to the TOP
    config['proxy-groups'].unshift(mainGroup);

    // 4. Add to existing groups (optional logic to add nodes to SELECT groups)
    config['proxy-groups'].forEach(g => {
        if (g.type === 'select' && g.name !== "${groupName}") {
            g.proxies.push("${groupName}");
        }
    });

    // 5. General Settings
    config['allow-lan'] = ${allowLan};
    ${dnsConfig}
    ${rulesConfig}
    ${adBlockConfig}

    return config;
}`;

                setOutput(script);
            }, [parsedNodes, mode, groupName, customDNS, blockAds, injectApps, allowLan]);

            const copyToClipboard = () => {
                navigator.clipboard.writeText(output);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            const downloadScript = () => {
                const element = document.createElement("a");
                const file = new Blob([output], {type: 'text/javascript'});
                element.href = URL.createObjectURL(file);
                element.download = "flyclash_override.js";
                document.body.appendChild(element);
                element.click();
            };

            // Icon Component Helper
            const Icon = ({ name, size=18, className }) => {
                const LucideIcon = lucide[name];
                return <LucideIcon size={size} className={className} />;
            };

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-7xl mx-auto flex flex-col gap-6">
                    {/* Header */}
                    <header className="flex justify-between items-center mb-4">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-gradient-to-br from-primary to-accent rounded-lg flex items-center justify-center shadow-lg shadow-cyan-500/20">
                                <Zap className="text-white" size={24} />
                            </div>
                            <div>
                                <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-cyan-300">
                                    FlyClash Generator
                                </h1>
                                <p className="text-slate-400 text-xs">Convert V2Ray to JS Override</p>
                            </div>
                        </div>
                        <div className="px-3 py-1 rounded-full border border-slate-700 bg-slate-800 text-xs font-mono text-cyan-400">
                            v1.0.0
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        {/* LEFT COLUMN: INPUT & SETTINGS */}
                        <div className="lg:col-span-1 space-y-6">
                            
                            {/* INPUT CARD */}
                            <div className="glass-panel p-5 rounded-xl space-y-3">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-sm font-semibold text-slate-300 flex items-center gap-2">
                                        <Terminal size={16} className="text-accent"/> Input Configuration
                                    </h2>
                                    <span className="text-xs text-slate-500">{parsedNodes.length} Nodes Detect</span>
                                </div>
                                <textarea 
                                    className="w-full h-48 bg-darker rounded-lg p-3 text-xs font-mono text-slate-300 border border-slate-700 focus:border-accent focus:outline-none resize-none"
                                    placeholder="Paste Vmess, Vless, Trojan, or Shadowsocks links here (one per line)..."
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                ></textarea>
                                {loading && <div className="w-full h-1 bg-slate-800 rounded overflow-hidden"><div className="h-full bg-accent animate-pulse w-1/2"></div></div>}
                            </div>

                            {/* SETTINGS CARD */}
                            <div className="glass-panel p-5 rounded-xl space-y-4">
                                <h2 className="text-sm font-semibold text-slate-300 flex items-center gap-2">
                                    <Settings size={16} className="text-primary"/> Generator Mode
                                </h2>
                                
                                {/* Mode Selector */}
                                <div className="space-y-1">
                                    <label className="text-xs text-slate-400">Group Strategy</label>
                                    <select 
                                        value={mode} 
                                        onChange={(e) => setMode(e.target.value)}
                                        className="w-full bg-darker border border-slate-700 text-slate-300 text-sm rounded-lg p-2 focus:border-primary focus:outline-none"
                                    >
                                        <option value="url-test">üöÄ Auto Best Ping (Url-Test)</option>
                                        <option value="load-balance">‚öñÔ∏è Load Balance (Round Robin)</option>
                                        <option value="fallback">üõ°Ô∏è Fallback (Backup Node)</option>
                                        <option value="select">üëÜ Manual Select</option>
                                    </select>
                                </div>

                                {/* Group Name */}
                                <div className="space-y-1">
                                    <label className="text-xs text-slate-400">Custom Group Name</label>
                                    <input 
                                        type="text" 
                                        value={groupName}
                                        onChange={(e) => setGroupName(e.target.value)}
                                        className="w-full bg-darker border border-slate-700 text-slate-300 text-sm rounded-lg p-2 focus:border-primary focus:outline-none"
                                    />
                                </div>

                                {/* DNS Selector */}
                                <div className="space-y-1">
                                    <label className="text-xs text-slate-400">DNS Override</label>
                                    <select 
                                        value={customDNS} 
                                        onChange={(e) => setCustomDNS(e.target.value)}
                                        className="w-full bg-darker border border-slate-700 text-slate-300 text-sm rounded-lg p-2 focus:border-primary focus:outline-none"
                                    >
                                        <option value="normal">Default (System/ISP)</option>
                                        <option value="google">Google DoH (8.8.8.8)</option>
                                        <option value="cloudflare">Cloudflare DoH (1.1.1.1)</option>
                                        <option value="adguard">AdGuard (Block Ads DNS)</option>
                                    </select>
                                </div>

                                {/* Toggles */}
                                <div className="grid grid-cols-2 gap-3 pt-2">
                                    <button 
                                        onClick={() => setBlockAds(!blockAds)}
                                        className={`p-2 rounded-lg border text-xs flex flex-col items-center gap-1 transition-colors ${blockAds ? 'border-red-500 bg-red-500/10 text-red-400' : 'border-slate-700 text-slate-500 hover:bg-slate-800'}`}
                                    >
                                        <Shield size={16} /> Block Ads
                                    </button>
                                    <button 
                                        onClick={() => setInjectApps(!injectApps)}
                                        className={`p-2 rounded-lg border text-xs flex flex-col items-center gap-1 transition-colors ${injectApps ? 'border-green-500 bg-green-500/10 text-green-400' : 'border-slate-700 text-slate-500 hover:bg-slate-800'}`}
                                    >
                                        <Globe size={16} /> App Rules
                                    </button>
                                    <button 
                                        onClick={() => setAllowLan(!allowLan)}
                                        className={`p-2 rounded-lg border text-xs flex flex-col items-center gap-1 transition-colors ${allowLan ? 'border-blue-500 bg-blue-500/10 text-blue-400' : 'border-slate-700 text-slate-500 hover:bg-slate-800'}`}
                                    >
                                        <Play size={16} /> Allow LAN
                                    </button>
                                    <button 
                                        onClick={() => setSkipCert(!skipCert)}
                                        className={`p-2 rounded-lg border text-xs flex flex-col items-center gap-1 transition-colors ${skipCert ? 'border-yellow-500 bg-yellow-500/10 text-yellow-400' : 'border-slate-700 text-slate-500 hover:bg-slate-800'}`}
                                    >
                                        <Check size={16} /> Skip Cert
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* RIGHT COLUMN: OUTPUT */}
                        <div className="lg:col-span-2 h-full flex flex-col">
                            <div className="glass-panel p-0 rounded-xl flex-1 flex flex-col overflow-hidden h-full">
                                {/* Output Header */}
                                <div className="p-4 border-b border-slate-700 bg-slate-800/50 flex justify-between items-center">
                                    <h2 className="text-sm font-semibold text-slate-300 flex items-center gap-2">
                                        <FileJson size={16} className="text-success"/> Generated Script
                                    </h2>
                                    <div className="flex gap-2">
                                        <button 
                                            onClick={downloadScript}
                                            className="px-3 py-1.5 rounded-md bg-slate-700 hover:bg-slate-600 text-slate-200 text-xs font-medium flex items-center gap-2 transition-all"
                                        >
                                            <Save size={14}/> Save .js
                                        </button>
                                        <button 
                                            onClick={copyToClipboard}
                                            className={`px-3 py-1.5 rounded-md text-xs font-medium flex items-center gap-2 transition-all ${copied ? 'bg-green-600 text-white' : 'bg-primary hover:bg-blue-600 text-white'}`}
                                        >
                                            {copied ? <Check size={14}/> : <Copy size={14}/>}
                                            {copied ? "Copied!" : "Copy Script"}
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Code View */}
                                <div className="flex-1 bg-darker p-4 overflow-auto relative font-mono text-xs leading-relaxed text-slate-300">
                                    <pre>{output}</pre>
                                </div>

                                {/* Footer Stats */}
                                <div className="bg-slate-900 border-t border-slate-800 p-2 px-4 flex justify-between text-[10px] text-slate-500 uppercase tracking-wider font-mono">
                                    <span>Mode: {mode.toUpperCase()}</span>
                                    <span>Chars: {output.length}</span>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            );
        };

        // Render React
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        // Initial Lucide icons render
        lucide.createIcons();
    </script>
</body>
</html>
